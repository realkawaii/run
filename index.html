<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©éš¨æ©Ÿè³½è·‘ - 8äººäº‚é¬¥ç‰ˆ</title>
    <style>
        :root {
            --grass-color: #7CFC00;
            --ui-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--grass-color);
            overflow: hidden; /* é˜²æ­¢æ»¾å‹• */
            touch-action: manipulation;
            user-select: none;
        }

        /* --- é»‘è‰²è²´è³“ç‹—å°ˆå±¬æ¨£å¼ --- */
        .black-poodle-filter {
            filter: grayscale(100%) brightness(30%); /* è®“ Emoji è®Šé»‘ */
        }

        /* --- UI é€šç”¨ --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; }

        h1 { 
            color: #333; 
            text-shadow: 2px 2px 0px white; 
            margin: 10px 0; 
            font-size: 24px;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            background: #ff4757;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 0 #c0392b;
            transition: transform 0.1s;
            margin-top: 15px;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* --- 1. é¸è§’ç•«é¢ --- */
        #selection-screen { background: rgba(0,0,0,0.3); overflow-y: auto; }
        
        .selection-container {
            background: var(--ui-bg);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .animal-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* ä¸€æ’5å€‹ */
            gap: 10px;
            margin-bottom: 15px;
        }

        .animal-btn {
            width: 55px;
            height: 55px;
            font-size: 30px;
            border: 2px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        
        /* é¸ä¸­ç‹€æ…‹ */
        .animal-btn.selected {
            background-color: #ddd;
            border-color: #999;
            transform: scale(0.9);
            opacity: 0.6;
        }
        
        .animal-btn:active { transform: scale(0.95); }

        /* æ’æ§½å€åŸŸ (æ”¹ç‚ºå…©æ’ Grid) */
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
            margin-top: 10px;
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 10px;
        }
        
        .slot {
            height: 60px;
            background: rgba(255,255,255,0.8);
            border: 2px dashed #999;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            position: relative;
        }
        .slot.filled {
            border-style: solid;
            border-color: #ff4757;
            background: #fff0f1;
        }
        .slot span { font-size: 10px; position: absolute; bottom: 2px; color: #888; width: 100%; text-align: center; }

        /* --- 2. æ¯”è³½ç•«é¢ --- */
        #race-screen {
            display: block;
            overflow-y: scroll; /* å…è¨±å‚ç›´æ»¾å‹• */
            -webkit-overflow-scrolling: touch;
        }

        .race-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 50px;
            background: rgba(255,255,255,0.9);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .track-container {
            margin-top: 60px; /* é¿é–‹ header */
            margin-bottom: 20px;
            width: 100%;
            position: relative;
            padding-right: 40px; 
            box-sizing: border-box;
        }

        .finish-line {
            position: absolute;
            right: 40px;
            top: 0;
            bottom: 0;
            width: 8px;
            background-image: repeating-linear-gradient(0deg, #333, #333 10px, #fff 10px, #fff 20px);
            z-index: 1;
        }

        .lane {
            height: 50px; /* ç¨å¾®è®Šçª„ä»¥å®¹ç´æ›´å¤šäºº */
            border-bottom: 1px solid rgba(255,255,255,0.5);
            position: relative;
            width: 100%;
        }
        
        .lane:nth-child(odd) { background-color: rgba(0,0,0,0.02); }

        .racer {
            font-size: 35px;
            position: absolute;
            left: 0;
            top: 5px;
            transition: left 0.1s linear; 
            z-index: 2;
            will-change: left; /* å„ªåŒ–æ•ˆèƒ½ */
        }
        
        .racer-name {
            position: absolute;
            top: -10px;
            left: 5px;
            font-size: 10px;
            background: rgba(255,255,255,0.8);
            padding: 1px 4px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
        }

        /* --- 3. çµç®—ç•«é¢ --- */
        #result-modal { background: rgba(0,0,0,0.85); color: white; }
        .podium { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 20px; }
        .podium-place {
            width: 60px; display: flex; flex-direction: column; align-items: center;
            border-radius: 8px 8px 0 0; color: #333; font-weight: bold;
        }
        .podium-place.first { height: 120px; background: #FFD700; order: 2; }
        .podium-place.second { height: 90px; background: #C0C0C0; order: 1; }
        .podium-place.third { height: 70px; background: #CD7F32; order: 3; }
        .winner-avatar { font-size: 40px; margin-top: -25px; margin-bottom: 5px; }

    </style>
</head>
<body>

    <div id="selection-screen" class="screen">
        <div class="selection-container">
            <h1>é¸æ“‡ 1~8 ä½é¸æ‰‹</h1>
            <p style="font-size:12px; color:#666; margin-top:-5px;">(å†é»ä¸€æ¬¡å¯å–æ¶ˆ)</p>
            
            <div class="animal-grid" id="animalGrid">
                </div>

            <div class="slots-grid" id="slotsArea">
                </div>

            <button id="startBtn" disabled onclick="startRace()">START RACE!</button>
        </div>
    </div>

    <div id="race-screen" class="screen hidden">
        <div class="race-header">
            <h2 id="race-status" style="margin:0;">Ready...</h2>
        </div>
        
        <div class="track-container" id="trackArea">
            <div class="finish-line"></div>
            </div>
    </div>

    <div id="result-modal" class="screen hidden">
        <h1>WINNER!</h1>
        <div class="podium">
            <div class="podium-place second">
                <div class="winner-avatar" id="win-2-avatar"></div>
                <div>2nd</div>
            </div>
            <div class="podium-place first">
                <div class="winner-avatar" id="win-1-avatar"></div>
                <div>1st</div>
            </div>
            <div class="podium-place third">
                <div class="winner-avatar" id="win-3-avatar"></div>
                <div>3rd</div>
            </div>
        </div>
        <div id="other-ranks" style="font-size: 14px; margin-bottom: 20px; color: #ccc;">
            </div>
        <button onclick="resetGame()">RETRY</button>
    </div>

    <script>
        // --- è³‡æ–™è¨­å®š ---
        // å®šç¾©è§’è‰²ï¼ŒclassName ç”¨æ–¼ç‰¹æ®Šæ¨£å¼ (å¦‚é»‘è‰²è²´è³“)
        const animals = [
            { icon: 'ğŸ©', name: 'Black Poodle', className: 'black-poodle-filter' }, // æ–°å¢çš„è§’è‰²
            { icon: 'ğŸ¶', name: 'Doge' },
            { icon: 'ğŸ±', name: 'Cat' },
            { icon: 'ğŸ­', name: 'Mouse' },
            { icon: 'ğŸ¹', name: 'Hamster' },
            { icon: 'ğŸ°', name: 'Rabbit' },
            { icon: 'ğŸ¦Š', name: 'Fox' },
            { icon: 'ğŸ»', name: 'Bear' },
            { icon: 'ğŸ¼', name: 'Panda' },
            { icon: 'ğŸ¨', name: 'Koala' },
            { icon: 'ğŸ¯', name: 'Tiger' },
            { icon: 'ğŸ¦', name: 'Lion' },
            { icon: 'ğŸ·', name: 'Pig' },
            { icon: 'ğŸ¸', name: 'Frog' },
            { icon: 'ğŸµ', name: 'Monkey' }
        ];

        const MAX_SLOTS = 8;
        // é™£åˆ—é•·åº¦æ”¹ç‚º 8ï¼Œnull ä»£è¡¨è©²ä½ç½®æ˜¯ç©ºçš„
        let selectedRacers = Array(MAX_SLOTS).fill(null);
        
        let racersData = [];
        let raceInterval = null;
        let finishedRacers = [];

        // --- åˆå§‹åŒ– ---
        const animalGrid = document.getElementById('animalGrid');
        const slotsArea = document.getElementById('slotsArea');

        // 1. å»ºç«‹å‹•ç‰©é¸å–®æŒ‰éˆ•
        animals.forEach((animal, index) => {
            const btn = document.createElement('div');
            btn.className = 'animal-btn';
            btn.id = `btn-animal-${index}`;
            
            // å¦‚æœæœ‰ç‰¹æ®Šæ¨£å¼ (å¦‚é»‘è‰²è²´è³“)ï¼ŒåŠ å…¥ span åŒ…è£¹
            if (animal.className) {
                btn.innerHTML = `<span class="${animal.className}">${animal.icon}</span>`;
            } else {
                btn.textContent = animal.icon;
            }
            
            btn.onclick = () => toggleSelection(index);
            animalGrid.appendChild(btn);
        });

        // 2. å»ºç«‹ä¸‹æ–¹æ’æ§½
        for (let i = 0; i < MAX_SLOTS; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.id = `slot-${i}`;
            slot.innerHTML = `<span>Lane ${i+1}</span>`;
            slotsArea.appendChild(slot);
        }

        // --- æ ¸å¿ƒé¸è§’é‚è¼¯ (Toggle) ---
        function toggleSelection(animalIndex) {
            const animal = animals[animalIndex];
            
            // æª¢æŸ¥é€™éš»å‹•ç‰©æ˜¯å¦å·²ç¶“åœ¨åå–®ä¸­ (ç”¨ name åˆ¤æ–·ï¼Œå› ç‚º object æ¯æ¬¡å»ºç«‹è¨˜æ†¶é«”ä½ç½®ä¸åŒ)
            const existingSlotIndex = selectedRacers.findIndex(r => r && r.name === animal.name);

            if (existingSlotIndex !== -1) {
                // æƒ…å¢ƒ A: å·²ç¶“é¸äº† -> å–æ¶ˆé¸æ“‡ (ç§»é™¤)
                selectedRacers[existingSlotIndex] = null;
            } else {
                // æƒ…å¢ƒ B: é‚„æ²’é¸ -> æ‰¾ç¬¬ä¸€å€‹ç©ºä½åŠ å…¥
                const emptySlotIndex = selectedRacers.findIndex(r => r === null);
                if (emptySlotIndex !== -1) {
                    selectedRacers[emptySlotIndex] = animal;
                } else {
                    // æ»¿äº†ï¼Œä¸åšäº‹ (æˆ–è€…å¯ä»¥æç¤ºå·²æ»¿)
                    return; 
                }
            }

            updateSelectionUI();
        }

        function updateSelectionUI() {
            // 1. æ›´æ–°æ’æ§½é¡¯ç¤º
            selectedRacers.forEach((racer, i) => {
                const slotEl = document.getElementById(`slot-${i}`);
                if (racer) {
                    let content = racer.className 
                        ? `<span class="${racer.className}">${racer.icon}</span>` 
                        : racer.icon;
                    slotEl.innerHTML = `${content}<span>Lane ${i+1}</span>`;
                    slotEl.classList.add('filled');
                } else {
                    slotEl.innerHTML = `<span>Lane ${i+1}</span>`;
                    slotEl.classList.remove('filled');
                }
            });

            // 2. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ (Selected æ¨£å¼)
            animals.forEach((animal, index) => {
                const btn = document.getElementById(`btn-animal-${index}`);
                const isSelected = selectedRacers.some(r => r && r.name === animal.name);
                if (isSelected) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            // 3. æª¢æŸ¥é–‹å§‹æŒ‰éˆ• (è‡³å°‘è¦æœ‰ 1 äººæ‰èƒ½é–‹å§‹)
            const count = selectedRacers.filter(r => r !== null).length;
            const startBtn = document.getElementById('startBtn');
            if (count > 0) {
                startBtn.disabled = false;
                startBtn.textContent = `START (${count})`;
                startBtn.style.transform = "scale(1.05)";
            } else {
                startBtn.disabled = true;
                startBtn.textContent = "PICK RACERS";
                startBtn.style.transform = "scale(1)";
            }
        }

        // --- é–‹å§‹æ¯”è³½ ---
        function startRace() {
            // éæ¿¾æ‰ null çš„æ’æ§½ï¼Œåªç•™ä¸‹çœŸæ­£çš„åƒè³½è€…ï¼Œé‡æ–°æ’åˆ—
            const activeRacers = selectedRacers.filter(r => r !== null);
            
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('race-screen').classList.remove('hidden');
            
            const trackArea = document.getElementById('trackArea');
            const finishLine = trackArea.querySelector('.finish-line');
            trackArea.innerHTML = '';
            trackArea.appendChild(finishLine);

            racersData = [];
            finishedRacers = [];
            
            // æ ¹æ“šå¯¦éš›åƒè³½è€…å»ºç«‹è·‘é“
            activeRacers.forEach((animal, index) => {
                const lane = document.createElement('div');
                lane.className = 'lane';
                
                const racerDiv = document.createElement('div');
                racerDiv.className = 'racer';
                
                // è™•ç†ç‰¹æ®Šæ¨£å¼
                let iconHtml = animal.className 
                    ? `<span class="${animal.className}">${animal.icon}</span>` 
                    : animal.icon;
                
                racerDiv.innerHTML = `${iconHtml}<div class="racer-name">${animal.name}</div>`;
                racerDiv.style.left = '0px';
                
                lane.appendChild(racerDiv);
                trackArea.appendChild(lane);

                racersData.push({
                    id: index,
                    element: racerDiv,
                    position: 0,
                    speed: 0,
                    info: animal,
                    finished: false
                });
            });

            // å€’æ•¸
            let count = 3;
            const statusText = document.getElementById('race-status');
            statusText.textContent = count;
            
            const countInterval = setInterval(() => {
                count--;
                if(count > 0) {
                    statusText.textContent = count;
                } else {
                    statusText.textContent = "GO!!!";
                    clearInterval(countInterval);
                    startEngine(activeRacers.length);
                }
            }, 600);
        }

        // --- è³½è·‘å¼•æ“ ---
        function startEngine(totalRacers) {
            raceInterval = setInterval(() => {
                if(finishedRacers.length === totalRacers) {
                    endRace();
                    return;
                }

                racersData.forEach(racer => {
                    if (racer.finished) return;

                    // éš¨æ©Ÿè®Šé€Ÿé‚è¼¯
                    if (Math.random() < 0.08) { 
                        racer.speed = Math.random() * 0.7 + 0.15; // åŸºç¤é€Ÿåº¦
                        if(Math.random() < 0.1) racer.speed += 0.8; // æš´è¡
                        if(Math.random() < 0.1) racer.speed *= 0.2; // åœæ»¯
                    }

                    racer.position += racer.speed;
                    
                    // è¢å¹•å¯¬åº¦ç™¾åˆ†æ¯”ï¼Œé ç•™å³é‚Šç©ºé–“
                    const maxPos = 90; 
                    racer.element.style.left = Math.min(racer.position, maxPos) + '%';

                    if (racer.position >= maxPos && !racer.finished) {
                        racer.finished = true;
                        finishedRacers.push(racer);
                    }
                });

            }, 20);
        }

        function endRace() {
            clearInterval(raceInterval);
            document.getElementById('race-status').textContent = "FINISHED!";
            setTimeout(showResults, 1200);
        }

        function showResults() {
            document.getElementById('result-modal').classList.remove('hidden');
            
            // é‡ç½®çå°
            ['win-1', 'win-2', 'win-3'].forEach(id => {
                document.getElementById(`${id}-avatar`).innerHTML = '';
            });

            // å¡«å…¥å‰ä¸‰å (éœ€è™•ç†åƒè³½è€…å°‘æ–¼3äººçš„æƒ…æ³)
            const setWinnerHtml = (elementId, racer) => {
                if(!racer) return;
                const el = document.getElementById(elementId);
                el.innerHTML = racer.info.className 
                    ? `<span class="${racer.info.className}">${racer.info.icon}</span>` 
                    : racer.info.icon;
            };

            setWinnerHtml('win-1-avatar', finishedRacers[0]);
            setWinnerHtml('win-2-avatar', finishedRacers[1]);
            setWinnerHtml('win-3-avatar', finishedRacers[2]);

            // é¡¯ç¤º 4~8 å
            const otherRanksDiv = document.getElementById('other-ranks');
            otherRanksDiv.innerHTML = '';
            if (finishedRacers.length > 3) {
                let text = "Rank 4+: ";
                for (let i = 3; i < finishedRacers.length; i++) {
                    text += finishedRacers[i].info.icon + " ";
                }
                otherRanksDiv.textContent = text;
            }
        }

        function resetGame() {
            selectedRacers = Array(MAX_SLOTS).fill(null);
            updateSelectionUI();
            
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('race-screen').classList.add('hidden');
            document.getElementById('selection-screen').classList.remove('hidden');
            document.getElementById('race-status').textContent = "Ready...";
        }

    </script>
</body>
</html>